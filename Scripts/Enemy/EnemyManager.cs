using System.Collections.Generic;
using TMPro;
using Unity.AI.Navigation;
using UnityEditor;
using UnityEngine;

/**
 * Klasa odpowiedzialna za zarz¹dzanie przeciwnikami
 * 
 * @author Artur Leszczak, Nikola Osiñska, Konrad Kondracki, Dawid Ugniewski
 * @version 1.1.0
 */
public class EnemyManager : MonoBehaviour
{
    public NavMeshSurface mesh;
    public static List<GameObject> listaPrzeciwnikow = new List<GameObject>();
    public Camera kamera;
    public static PlacePath sciezka;
    private float elapsedTime = 0f;
    public float interval = 0f;
    int ilosc = 20;
    int iloscodmierzacz = 20;

    [SerializeField]
    GameObject PrefabVillager;
    public static bool czyPosagZabrany;

    public TextMeshProUGUI tekst;
    public TextMeshProUGUI levelText;
    private int numerfali=0;

    [SerializeField]
    private EnemyFactory enemyVillager1;
    [SerializeField]
    private EnemyFactory enemyKnite;
    public Vector3 cel;
    public static bool rozpocznijPrzygotowanie = true;
    private bool widocznoscPaskuZycia = true;
    FloorManager siatkaPlanszy;


    void Start()
    {
        sciezka = kamera.GetComponent<PlacePath>();
        czyPosagZabrany = false;
        
        /**
         * Pobranie komponentów klas odpowiedzialnych za przeciwników
         */
        this.enemyVillager1 = gameObject.GetComponent<DefaultEnemyFactory>();
        this.enemyKnite = gameObject.GetComponent<KniteEnemyFactory>();
        
        siatkaPlanszy = gameObject.GetComponent<FloorManager>();
    }
    private void Awake()
    {
        //Application.targetFrameRate = 60;
    }

    private void Update()
    {
       
        if(widocznoscPaskuZycia==true)
        {
            WidocznoscPaskowZycia(true);
        }
        else
        {
            WidocznoscPaskowZycia(false);
        }

    }
    GameObject postac;

    public void WidocznoscPaskowZycia(bool stan)
    {
        foreach( GameObject przeciwnik in listaPrzeciwnikow){
           enemyVillager enemy= przeciwnik.GetComponent<enemyVillager>();
            enemy.UstawWidocznoscObiektów(stan);
        }
    }

    /**
     * Metoda dodaj¹ca nowego przeciwnika "wieœniaka" do listy przeciwników
     *
     * @author Artur Leszczak
     * @version 1.0.0
     */
    public void GetEnemyVillager()
    {
        Vector3 newStart = sciezka.getStartPosition();
        newStart = new Vector3(newStart.x, newStart.y, newStart.z);

        this.enemyVillager1.setStartPoint(newStart);
        postac = this.enemyVillager1.createEnemy();

        listaPrzeciwnikow.Add(postac);
    }

    /**
    * Metoda dodaj¹ca nowego przeciwnika "wieœniaka bosa" do listy przeciwników
    *
    * @author Artur Leszczak
    * @version 1.0.0
    */
    public void GetEnemyVillagerBoss()
    {
        Vector3 newStart = sciezka.getStartPosition();
        newStart = new Vector3(newStart.x, newStart.y, newStart.z);

        this.enemyVillager1.setStartPoint(newStart);
        postac = this.enemyVillager1.createEnemyBoss();

        listaPrzeciwnikow.Add(postac);

    }

    /**
    * Metoda dodaj¹ca nowego przeciwnika "rycerza" do listy przeciwników
    *
    * @author Artur Leszczak
    * @version 1.0.0
    */
    public void GetEnemyKnite()
    {
        Vector3 newStart = sciezka.getStartPosition();
        newStart = new Vector3(newStart.x, newStart.y, newStart.z);

        this.enemyKnite.setStartPoint(newStart);
        postac = this.enemyKnite.createEnemy();

        listaPrzeciwnikow.Add(postac);

    }

    /**
    * Metoda dodaj¹ca nowego przeciwnika "rycerza bosa" do listy przeciwników
    *
    * @author Artur Leszczak
    * @version 1.0.0
    */
    public void GetEnemyKniteBoss()
    {
        Vector3 newStart = sciezka.getStartPosition();
        newStart = new Vector3(newStart.x, newStart.y, newStart.z);

        this.enemyKnite.setStartPoint(newStart);
        postac = this.enemyKnite.createEnemyBoss();

        listaPrzeciwnikow.Add(postac);

    }
    int licznik = 0;
    /**
     * Metoda która pojawia na mapie przeciwnika co okreœlony interwa³ czasu , pilnuje te¿ ilu przeciwników mo¿e byæ w turze na mapie.
     * Podmienia przeciwnika który podnieœie pos¹¿êk na model z pos¹giem w rêce.
     * 
     * @author Konrad Kondracki, Nikola Osiñska
     */
    void FixedUpdate()
    {
        elapsedTime += Time.fixedDeltaTime;

        

        levelText.text = "" + numerfali;

        // SprawdŸ, czy up³yn¹³ okreœlony interwa³ czasowy
        if ( elapsedTime >= interval && iloscodmierzacz!=ilosc  )
        {
            if(iloscodmierzacz==0)
            mesh.BuildNavMesh();

            siatkaPlanszy.Hide();

            tekst.text = "Walka!";
            iloscodmierzacz++;
            // Wykonaj kod, który ma byæ wywo³any po danym interwale czasowym

            if (iloscodmierzacz == 10 || iloscodmierzacz == 20)
            {
               // GetEnemyKnite();
            } 
            else if(licznik<=10)
            {
                licznik++;
                GetEnemyVillager();
            }

            // Zresetuj licznik czasu
            elapsedTime = 0f;
        }
        if(listaPrzeciwnikow.Count==0 && rozpocznijPrzygotowanie==true)
        {   tekst.text = ""+numerfali;

            siatkaPlanszy.Show();
            tekst.text = (15f - Mathf.Floor(elapsedTime)) + "s";
            tekst.GetComponent<Animator>().SetTrigger("odpalAnimacje");

            //tekst.GetComponent<Animation>().Play();
            if (elapsedTime >= 15f)
            {
                licznik = 0;
                iloscodmierzacz = 0;
                rozpocznijPrzygotowanie = false;
                numerfali += 1;
                tekst.GetComponent<Animator>().ResetTrigger("odpalAnimacje");
                tekst.GetComponent<Animator>().SetTrigger("wylaczAnimacje");
                tekst.text = "Walka!";

            }
            

        }
        if (sciezka.posag == null && czyPosagZabrany == false)
        {
            
            czyPosagZabrany = true;
            GameObject postac;
            Debug.Log("posag zabrany??: ");
            EnemyFactory ef = gameObject.GetComponent<DefaultEnemyFactory>();
            postac = Instantiate(ef.createEnemy(), PlacePath.pozycjaPosagu, Quaternion.identity);
            postac.AddComponent<enemyVillager>();
            postac.tag = "EnemyWithStatue";
            enemyVillager pierwsza = postac.GetComponent<enemyVillager>();
            pierwsza.GetDesiredPoint();
            Debug.Log("Zaczynam tworzyc postac z pos¹giem");
            

            pierwsza.NavMeshAgent.SetDestination(enemyVillager.cel);
            listaPrzeciwnikow.Add(postac);

            // Znisz posag po podniesieniu
            zmianaKierunkuWszystkich();
            pierwsza.TakeDamage(60);
            Debug.Log("Tworze postac z posagiem");

            Destroy(sciezka.posag);
          
        }

    }

    /**
     * Metoda aktualizuj¹ca cel do którego d¹¿¹ przeciwnicy na podstawie tego jaki cel maj¹ okreœlony w swojej instancji.
     * 
     */
    public void zmianaKierunkuWszystkich()
    {
        foreach(GameObject przeciwnik in listaPrzeciwnikow)
        {
            Debug.Log("Zawracam"+ listaPrzeciwnikow.Count);
            enemyVillager enemy=przeciwnik.GetComponent<enemyVillager>();
            //enemy.powrot = true;
            enemy.NavMeshAgent.SetDestination(enemyVillager.cel);

        }
    }

    public static void SetCzyPosagZabrany(bool czyPosagZabrany) { EnemyManager.czyPosagZabrany = czyPosagZabrany; }
}
